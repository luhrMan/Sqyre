# AppImage recipe for Sqyre.
# Run from repo root: .devcontainer/builds/linux/packaging/appimage/build-appimage.sh
# Or from this directory: ./build-appimage.sh
# Uses sqyre.AppDir (set via build-appimage.sh --appdir).
#
# Script installs the binary and metadata; appimage-builder then
# traces the binary and bundles all required .so files (OpenCV, Tesseract, X11, etc.).
# We do not use the recipe "apt" section because appimage-builder has a bug comparing
# Ubuntu package versions (e.g. "1.22.6ubuntu6") with packaging.version.parse().

version: 1
script:
  - cd "$SOURCE_DIR/../../../../.."
  - go build -trimpath -o "$TARGET_APPDIR/usr/bin/sqyre" ./cmd/sqyre
  - install -Dm00644 internal/assets/icons/sqyre.png "$TARGET_APPDIR/usr/share/icons/hicolor/256x256/apps/com.sqyre.app.png"
  - install -Dm00644 "$SOURCE_DIR/com.sqyre.app.desktop" "$TARGET_APPDIR/usr/share/applications/com.sqyre.app.desktop"
  # Bundle Tesseract English data so OCR works without system tessdata
  - mkdir -p "$TARGET_APPDIR/usr/share/tessdata"
  - |
    if [ -f /usr/share/tessdata/eng.traineddata ]; then
      cp /usr/share/tessdata/eng.traineddata "$TARGET_APPDIR/usr/share/tessdata/"
    fi
  # Explicitly bundle OpenCV, Tesseract, and Leptonica shared libraries.
  # appimage-builder tracing may miss libs whose code paths aren't exercised
  # during the brief strace run.
  - mkdir -p "$TARGET_APPDIR/usr/lib"
  - |
    # OpenCV (built from source, installed to /usr/local/lib)
    cp -aL /usr/local/lib/libopencv_*.so* "$TARGET_APPDIR/usr/lib/" 2>/dev/null || true
    # Tesseract and Leptonica (from system packages)
    cp -aL /usr/lib/x86_64-linux-gnu/libtesseract.so* "$TARGET_APPDIR/usr/lib/" 2>/dev/null || true
    cp -aL /usr/lib/x86_64-linux-gnu/liblept.so* "$TARGET_APPDIR/usr/lib/" 2>/dev/null || true
    # Transitive deps of OpenCV imgcodecs and Tesseract (image format libs)
    for dep in libjpeg libpng libtiff libwebp libopenjp2 libIlmImf libHalf; do
      cp -aL /usr/lib/x86_64-linux-gnu/${dep}*.so* "$TARGET_APPDIR/usr/lib/" 2>/dev/null || true
    done

AppDir:
  path: "{{ TARGET_APPDIR }}"
  app_info:
    id: com.sqyre.app
    name: Sqyre
    icon: com.sqyre.app
    version: "0.5.0"
    exec: usr/bin/sqyre
    exec_args: "$@"
  files:
    exclude:
      - usr/share/man
      - usr/share/doc/*
  runtime:
    env:
      TESSDATA_PREFIX: "${APPDIR}/usr/share"
      APPDIR_LIBRARY_PATH: "${APPDIR}/usr/lib:${APPDIR}/lib/x86_64"

AppImage:
  arch: x86_64
  file_name: Sqyre-0.5.0-x86_64.AppImage
